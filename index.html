<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>KONZIA – My List</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial,
          sans-serif;
        background: #f5f5f5;
      }
      header {
        background: #ff4757;
        color: #fff;
        padding: 12px 16px;
        font-size: 1.2rem;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .tabs {
        display: flex;
        background: #fff;
        border-bottom: 1px solid #e0e0e0;
      }
      .tab {
        flex: 1;
        text-align: center;
        padding: 12px 0;
        cursor: pointer;
        transition: 0.2s;
      }
      .tab.active {
        color: #ff4757;
        border-bottom: 2px solid #ff4757;
      }
      .content {
        padding: 12px;
      }
      .card {
        display: flex;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .card img {
        width: 80px;
        height: 80px;
        object-fit: cover;
      }
      .info {
        flex: 1;
        padding: 8px 12px;
      }
      .info h4 {
        font-size: 0.95rem;
        margin-bottom: 3px;
      }
      .price {
        font-size: 0.8rem;
        color: #666;
      }
      .price b {
        color: #000;
      }
      .btn {
        align-self: center;
        margin-right: 12px;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
      }
      .add-btn {
        background: #ff4757;
        color: #fff;
      }
      .remove-btn {
        background: #ddd;
        color: #444;
      }
      .empty {
        text-align: center;
        margin-top: 40px;
        color: #888;
      }
      .total {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        padding: 12px;
        text-align: center;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.06);
        font-weight: 600;
      }
    </style>
  </head>

  <body>
    <header>KONZIA – My List</header>

    <div class="tabs">
      <div class="tab active" data-tab="catalog">Catalog</div>
      <div class="tab" data-tab="list">My List</div>
    </div>

    <div id="catalog" class="content"></div>
    <div id="list" class="content" style="display:none"></div>

    <div class="total" id="total">Total: $0.00</div>

    <script>
      /* ---------- static catalog ---------- */
      const catalog = [
        { id: 'prod-001', name: 'Organic Avocado', image: 'https://via.placeholder.com/80?text=A' },
        { id: 'prod-002', name: 'Whole Milk 1L', image: 'https://via.placeholder.com/80?text=M' },
        { id: 'prod-003', name: 'Sourdough Bread', image: 'https://via.placeholder.com/80?text=B' },
      ];

      /* ---------- state ---------- */
      let myList = [];
      const watchers = {};

      /* ---------- API helper ---------- */
      async function getPrice(productId) {
        const res = await fetch(`/api/index.js?product=${encodeURIComponent(productId)}`);
        return res.json();
      }

      /* ---------- render helpers ---------- */
      function renderCatalog() {
        const c = document.getElementById('catalog');
        c.innerHTML = '';
        catalog.forEach((p) => {
          const inList = myList.some((i) => i.id === p.id);
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <img src="${p.image}" alt="${p.name}" />
            <div class="info">
              <h4>${p.name}</h4>
            </div>
            <button class="btn ${inList ? 'remove-btn' : 'add-btn'}" data-id="${p.id}">
              ${inList ? 'Added' : 'Add'}
            </button>
          `;
          c.appendChild(div);
        });
      }

      function renderList() {
        const l = document.getElementById('list');
        l.innerHTML = '';
        if (!myList.length) {
          l.innerHTML = '<div class="empty">Your list is empty.</div>';
          updateTotal(0);
          return;
        }
        myList.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <img src="${item.image}" alt="${item.name}" />
            <div class="info">
              <h4>${item.name}</h4>
              <div class="price">
                Avg: $${item.priceInfo.avgPrice}<br />
                Cheapest: <b>${item.priceInfo.cheapestStore} – $${item.priceInfo.cheapestPrice}</b><br />
                Range: $${item.priceInfo.priceRange.min} – $${item.priceInfo.priceRange.max}
              </div>
            </div>
            <button class="btn remove-btn" data-id="${item.id}">Remove</button>
          `;
          l.appendChild(div);
        });
        const total = myList.reduce((s, i) => s + parseFloat(i.priceInfo.cheapestPrice), 0);
        updateTotal(total);
      }

      function updateTotal(amount) {
        document.getElementById('total').textContent = `Total: $${amount.toFixed(2)}`;
      }

      /* ---------- background watcher ---------- */
      function startWatcher(item) {
        if (watchers[item.id]) return;
        watchers[item.id] = setInterval(async () => {
          const newInfo = await getPrice(item.id);
          const old = parseFloat(item.priceInfo.cheapestPrice);
          const now = parseFloat(newInfo.cheapestPrice);
          if (now < old) {
            alert(
              `Price drop! ${item.name} is now $${now} at ${newInfo.cheapestStore} (was $${old})`
            );
            item.priceInfo = newInfo;
            renderList();
          }
        }, 15 * 60 * 1000); // 15 minutes
      }

      function stopWatcher(id) {
        if (watchers[id]) {
          clearInterval(watchers[id]);
          delete watchers[id];
        }
      }

      /* ---------- events ---------- */
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.dataset.id;
        const prod = catalog.find((p) => p.id === id) || myList.find((i) => i.id === id);
        if (!prod) return;

        if (btn.textContent.trim() === 'Add') {
          btn.disabled = true;
          btn.textContent = '…';
          const priceInfo = await getPrice(id);
          myList.push({ ...prod, priceInfo });
          btn.textContent = 'Added';
          btn.classList.replace('add-btn', 'remove-btn');
          btn.disabled = false;
          startWatcher(myList[myList.length - 1]);
          if (activeTab === 'list') renderList();
        } else {
          myList = myList.filter((i) => i.id !== id);
          stopWatcher(id);
          renderCatalog();
          renderList();
        }
      });

      /* ---------- tab switch ---------- */
      let activeTab = 'catalog';
      document.querySelectorAll('.tab').forEach((tab) =>
        tab.addEventListener('click', () => {
          document.querySelector('.tab.active').classList.remove('active');
          tab.classList.add('active');
          document.querySelectorAll('.content').forEach((c) => (c.style.display = 'none'));
          const target = tab.dataset.tab;
          document.getElementById(target).style.display = 'block';
          activeTab = target;
          if (target === 'list') renderList();
        })
      );

      /* ---------- init ---------- */
      renderCatalog();
    </script>
  </body>
</html>
