<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>KONZIA – My List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          font-src     'self' https://fonts.gstatic.com;
          style-src    'self' 'unsafe-inline' https://fonts.googleapis.com;
          connect-src  'self' https://script.google.com https://script.googleusercontent.com;
          img-src      'self' data: https://via.placeholder.com;
          object-src   'none';
          base-uri     'none';
          frame-ancestors 'none';
        ">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#0b8043;
      --brand-light:#e6f4ea;
      --surface:#ffffff;
      --surface-variant:#f8faf8;
      --on-surface:#1f1f1f;
      --on-surface-variant:#444746;
      --outline:#c4c7c5;
      --outline-variant:#e1e3e1;
      --error:#c62828;
      --radius:20px;
      --radius-pill:100px;
      --shadow-1:0 2px 8px 0 rgba(0,0,0,.06),0 2px 4px 0 rgba(0,0,0,.04);
      --shadow-2:0 4px 12px 0 rgba(0,0,0,.08),0 2px 8px 0 rgba(0,0,0,.06);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Google Sans',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--surface-variant);
      color:var(--on-surface);
      min-height:100vh;
      padding:24px;
      font-size:15px;
    }
    #loadingScreen{
      position:fixed;inset:0;background:#fff;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      z-index:9999;transition:opacity .4s ease,visibility .4s ease;
    }
    #loadingScreen.fade-out{opacity:0;visibility:hidden}
    #loadingScreen .brand{font-size:32px;font-weight:600;color:var(--brand);margin-bottom:8px;animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .ring{width:40px;height:40px;border:4px solid var(--outline-variant);border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    header{
      position:sticky;top:0;z-index:10;
      background:var(--brand);color:#fff;
      padding:16px 24px;font-weight:600;font-size:1.25rem;
      border-radius:var(--radius) var(--radius) 0 0;
    }
    .tabs{
      display:flex;background:var(--surface);
      box-shadow:var(--shadow-1);
    }
    .tab{
      flex:1;text-align:center;padding:18px 0;
      font-weight:600;font-size:.95rem;
      color:var(--on-surface-variant);cursor:pointer;
      transition:.2s;
    }
    .tab.active{color:var(--brand);border-bottom:2px solid var(--brand)}
    .content{padding:24px}
    .card{
      display:flex;align-items:center;
      background:var(--surface);
      border-radius:var(--radius);
      margin-bottom:12px;
      box-shadow:var(--shadow-1);
      padding:16px;
      transition:.25s;
    }
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-2)}
    .info{flex:1;padding:0 12px}
    .info h4{margin:0 0 4px;font-size:1rem;color:var(--on-surface)}
    .price{font-size:.85rem;color:var(--on-surface-variant)}
    .price b{color:var(--on-surface)}
    .btn{
      padding:8px 18px;
      border:none;border-radius:var(--radius-pill);
      font-weight:600;font-size:.85rem;
      cursor:pointer;transition:.2s;
    }
    .add-btn{background:var(--brand);color:#fff}
    .add-btn:hover{background:#086e3b}
    .remove-btn{background:var(--outline-variant);color:var(--on-surface)}
    .remove-btn:hover{background:var(--outline)}
    .empty{text-align:center;margin-top:40px;color:var(--on-surface-variant)}
    .total{
      position:fixed;bottom:0;left:0;right:0;
      background:var(--surface);padding:16px;
      text-align:center;font-weight:600;font-size:1rem;
      box-shadow:0 -2px 8px rgba(0,0,0,.06)
    }
  </style>
</head>
<body>

<!-- ---------- loading screen ---------- -->
<div id="loadingScreen" aria-live="polite" aria-busy="true">
  <div class="brand">Konzia</div>
  <div class="ring" aria-label="Loading spinner"></div>
</div>

<!-- ---------- main app ---------- -->
<div id="app" style="display:none" role="main" aria-hidden="true">
  <header>KONZIA – My List</header>
  <nav class="tabs" role="tablist">
    <div class="tab active" data-tab="catalog" role="tab" aria-selected="true" tabindex="0" aria-controls="catalog">Catalog</div>
    <div class="tab" data-tab="list" role="tab" aria-selected="false" tabindex="-1" aria-controls="list">My List</div>
  </nav>

  <section id="catalog" class="content" role="tabpanel" aria-labelledby="catalog-tab"></section>
  <section id="list" class="content" style="display:none;" role="tabpanel" aria-labelledby="list-tab"></section>
  <div class="total" id="total" aria-live="polite" aria-atomic="true">Total: R0.00</div>
</div>

<script>
  const SHEET_URL = 'https://script.google.com/macros/s/AKfycbwWlfeN4OijCyUvL4FCdcwDY10ZYnERuKV0E3cDZ-VZH1WFxEErFusOi3nzld3WKbb0aw/exec';
  const STORAGE_KEY = 'konzia-myList';

  let catalog = [];
  let myList = [];
  const watchers = {};
  let activeTab = 'catalog';

  // Save list to localStorage
  function saveList() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(myList.map(item => ({
        id: item.id,
        name: item.name,
        priceInfo: item.priceInfo
      }))));
    } catch(e) {
      console.warn('Failed to save list:', e);
    }
  }

  // Load list from localStorage, match with current catalog items
  function loadList() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const saved = JSON.parse(raw);
      return saved.map(item => {
        const base = catalog.find(p => p.id === item.id);
        return base ? { ...base, priceInfo: item.priceInfo } : null;
      }).filter(Boolean);
    } catch(e) {
      console.warn('Failed to load list:', e);
      return [];
    }
  }

  // Fetch catalog from backend
  async function getCatalog() {
    try {
      const r = await fetch(SHEET_URL);
      if (!r.ok) throw new Error(`Catalog fetch failed with status ${r.status}`);
      const j = await r.json();
      return Array.isArray(j?.products) ? j.products : [];
    } catch(e) {
      console.error('Error fetching catalog:', e);
      return [];
    }
  }

  // Fetch price info for one product
  async function getPrice(productName) {
    try {
      const url = new URL(SHEET_URL);
      url.searchParams.set('product', productName);
      const r = await fetch(url);
      if (!r.ok) throw new Error(`Price fetch failed with status ${r.status}`);
      const data = await r.json();
      return {
        avgPrice: parseFloat(data.avgPrice) || 0,
        cheapestPrice: parseFloat(data.cheapestPrice) || 0,
        cheapestStore: data.cheapestStore || 'N/A',
        priceRange: {
          min: parseFloat(data.priceRange?.min) || 0,
          max: parseFloat(data.priceRange?.max) || 0
        }
      };
    } catch(e) {
      console.error(`Failed to fetch price for ${productName}:`, e);
      return {
        avgPrice: 0,
        cheapestPrice: 0,
        cheapestStore: 'N/A',
        priceRange: { min: 0, max: 0 }
      };
    }
  }

  // Render catalog tab
  function renderCatalog() {
    const container = document.getElementById('catalog');
    container.innerHTML = '';
    if (catalog.length === 0) {
      container.innerHTML = '<div class="empty">No products in sheet yet.</div>';
      return;
    }
    catalog.forEach(p => {
      const inList = myList.some(i => i.id === p.id);
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="info"><h4>${p.name}</h4></div>
        <button class="btn ${inList ? 'remove-btn' : 'add-btn'}" data-id="${p.id}">${inList ? 'Added' : 'Add'}</button>
      `;
      container.appendChild(card);
    });
  }

  // Render list tab
  function renderList() {
    const container = document.getElementById('list');
    container.innerHTML = '';
    if (myList.length === 0) {
      container.innerHTML = '<div class="empty">Your list is empty.</div>';
      updateTotal(0);
      return;
    }
    myList.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="info">
          <h4>${item.name}</h4>
          <div class="price">
            Avg: R${item.priceInfo.avgPrice.toFixed(2)}<br>
            Cheapest: <b>${item.priceInfo.cheapestStore} – R${item.priceInfo.cheapestPrice.toFixed(2)}</b><br>
            Range: R${item.priceInfo.priceRange.min.toFixed(2)} – R${item.priceInfo.priceRange.max.toFixed(2)}
          </div>
        </div>
        <button class="btn remove-btn" data-id="${item.id}">Remove</button>
      `;
      container.appendChild(card);
    });
    const total = myList.reduce((sum, item) => sum + (parseFloat(item.priceInfo.cheapestPrice) || 0), 0);
    updateTotal(total);
  }

  // Update total price display
  function updateTotal(amount) {
    document.getElementById('total').textContent = 'Total: R' + amount.toFixed(2);
  }

  // Start watching price for a list item (poll every 15 min)
  function startWatcher(item) {
    if (watchers[item.id]) return; // avoid duplicates
    watchers[item.id] = setInterval(async () => {
      try {
        const newInfo = await getPrice(item.name);
        const oldPrice = parseFloat(item.priceInfo.cheapestPrice) || 0;
        const newPrice = parseFloat(newInfo.cheapestPrice) || 0;
        if (newPrice < oldPrice) {
          alert(`Price drop! ${item.name} is now R${newPrice.toFixed(2)} at ${newInfo.cheapestStore} (was R${oldPrice.toFixed(2)})`);
          item.priceInfo = newInfo;
          saveList();
          if (activeTab === 'list') renderList();
        }
      } catch (e) {
        console.warn('Watcher error:', e);
      }
    }, 15 * 60 * 1000);
  }

  // Stop watcher for removed items
  function stopWatcher(id) {
    if (watchers[id]) {
      clearInterval(watchers[id]);
      delete watchers[id];
    }
  }

  // Handle Add/Remove button clicks with event delegation
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const id = btn.dataset.id;
    if (!id) return;

    // Find product in catalog or list
    const prodInCatalog = catalog.find(p => p.id === id);
    const prodInList = myList.find(p => p.id === id);

    // Add item
    if (btn.textContent.trim() === 'Add' && prodInCatalog) {
      btn.disabled = true;
      btn.textContent = '…';
      try {
        const priceInfo = await getPrice(prodInCatalog.name);
        myList.push({ ...prodInCatalog, priceInfo });
        saveList();
        startWatcher(myList.at(-1));
        btn.textContent = 'Added';
        btn.className = 'btn remove-btn';
        if (activeTab === 'list') renderList();
      } catch (e) {
        alert('Failed to add item. Try again.');
        console.error('Add item error:', e);
        btn.textContent = 'Add';
      }
      btn.disabled = false;
      renderCatalog(); // refresh catalog buttons to update added status
      return;
    }

    // Remove item
    if (btn.textContent.trim() === 'Remove' && prodInList) {
      myList = myList.filter(item => item.id !== id);
      saveList();
      stopWatcher(id);
      renderCatalog();
      if (activeTab === 'list') renderList();
      return;
    }
  });

  // Tab switching logic
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      if (tab.classList.contains('active')) return; // ignore repeated clicks
      document.querySelector('.tab.active').classList.remove('active');
      tab.classList.add('active');

      const target = tab.dataset.tab;
      activeTab = target;

      document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
      document.getElementById(target).style.display = 'block';

      if (target === 'catalog') renderCatalog();
      else if (target === 'list') renderList();
    });
  });

  // Initial app boot with error handling
  (async () => {
    try {
      catalog = await getCatalog();
      myList = loadList();
      renderCatalog();
      myList.forEach(startWatcher);

      // Show app, hide loader
      const loading = document.getElementById('loadingScreen');
      const app = document.getElementById('app');
      setTimeout(() => {
        loading.classList.add('fade-out');
        app.style.display = 'block';
        app.setAttribute('aria-hidden', 'false');
        loading.setAttribute('aria-busy', 'false');
      }, 1000);
    } catch (e) {
      console.error('Failed to boot app:', e);
      alert('Failed to load app data. Please try again later.');
      document.getElementById('loadingScreen').classList.add('fade-out');
    }
  })();
</script>
</body>
</html>
